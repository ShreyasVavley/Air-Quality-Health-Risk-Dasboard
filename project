import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import os
import sys

# --- 1. Data Processing and AQI/Risk Calculation Functions ---

def calculate_iaqi(C, I_low, I_high, C_low, C_high):
    """Calculates the Individual Air Quality Index (IAQI) via linear interpolation."""
    if C_high == C_low:
        return I_high
    IAQI = ((I_high - I_low) / (C_high - C_low)) * (C - C_low) + I_low
    return IAQI

def get_aqi_sub_index(concentration, breakpoints):
    """Finds the correct IAQI for a given pollutant concentration."""
    if pd.isna(concentration) or concentration < 0:
        return np.nan
        
    if concentration <= breakpoints[0][1]:
        c_low, c_high, i_low, i_high = breakpoints[0]
        return calculate_iaqi(concentration, i_low, i_high, c_low, c_high)

    for c_low, c_high, i_low, i_high in breakpoints:
        if c_low < concentration <= c_high:
            return calculate_iaqi(concentration, i_low, i_high, c_low, c_high)
            
    return 500
    
def calculate_aqi_and_risk(df, pm_col_name): 
    """Processes the DataFrame to calculate AQI and Health Risk based on the identified PM column."""
    
    PM25_BREAKPOINTS = [
        (0.0, 12.0, 0, 50),
        (12.1, 35.4, 51, 100),
        (35.5, 55.4, 101, 150),
        (55.5, 150.4, 151, 200),
        (150.5, 250.4, 201, 300),
        (250.5, 500.4, 301, 500)
    ]
    
    # 1. Calculate Sub-Index (IAQI)
    df['PM25_IAQI'] = df[pm_col_name].apply(lambda c: get_aqi_sub_index(c, PM25_BREAKPOINTS))
    
    # 2. Calculate Overall AQI 
    df['AQI'] = df['PM25_IAQI'].copy()

    # 3. Determine Health Risk Category
    def get_risk_category(aqi):
        if aqi <= 50: return "Good"
        elif aqi <= 100: return "Moderate"
        elif aqi <= 150: return "Unhealthy for Sensitive Groups"
        elif aqi <= 200: return "Unhealthy"
        elif aqi <= 300: return "Very Unhealthy"
        else: return "Hazardous"
        
    df['Risk_Category'] = df['AQI'].apply(get_risk_category)
    return df

# --- 2. Tkinter Dashboard Application Class ---

class AirQualityDashboard(tk.Tk):
    def __init__(self):
        super().__init__()
        self.title("Air Quality & Health Risk Dashboard")
        self.geometry("1000x700") 
        self.data = None
        self.current_canvas = None 
        self.pm_col_name = None 

        self.style = ttk.Style(self)
        self.style.theme_use('clam') 
        self.configure_styles()
        
        self.notebook = ttk.Notebook(self)
        self.notebook.pack(expand=True, fill='both', padx=10, pady=10)

        self.upload_tab = ttk.Frame(self.notebook, padding="15")
        self.dashboard_tab = ttk.Frame(self.notebook, padding="15")
        
        self.notebook.add(self.upload_tab, text='ðŸ“Š Data Uploader')
        self.notebook.add(self.dashboard_tab, text='ðŸ“ˆ Dashboard')

        self.create_upload_ui()
        self.create_dashboard_ui(initial=True) 

    def configure_styles(self):
        """Customizing TTK styles for a cleaner Tkinter UI."""
        self.style.configure('TFrame', background='#f5f5f5')
        self.style.configure('TLabel', background='#f5f5f5', font=('Helvetica', 10))
        self.style.configure('Header.TLabel', font=('Helvetica', 16, 'bold'), foreground='#333366')
        self.style.configure('Upload.TButton', font=('Helvetica', 12, 'bold'), foreground='white', background='#007bff', padding=10)
        self.style.map('Upload.TButton', background=[('active', '#0056b3')])

    def create_upload_ui(self):
        """Creates the file upload interface."""
        
        ttk.Label(self.upload_tab, text="Air Quality Data Import", style='Header.TLabel').pack(pady=(40, 10))
        
        instruction_frame = ttk.Frame(self.upload_tab, relief=tk.GROOVE, borderwidth=1, padding=10)
        instruction_frame.pack(pady=20, padx=50, fill='x')
        ttk.Label(instruction_frame, text="1. Click the button below to select your CSV file.", anchor='w').pack(fill='x')
        ttk.Label(instruction_frame, text="2. The file MUST contain a column related to PM2.5 (e.g., 'PM 2.5', 'PM2.5').", anchor='w', wraplength=500, font=('Helvetica', 9, 'italic')).pack(fill='x')
        
        self.path_label = ttk.Label(self.upload_tab, text="No file selected. Dashboard requires data.", wraplength=600)
        self.path_label.pack(pady=15)

        upload_button = ttk.Button(self.upload_tab, 
                                 text="ðŸ“‚ Select & Analyze CSV File", 
                                 command=self.load_csv_data,
                                 style='Upload.TButton')
        upload_button.pack(pady=30, ipadx=20, ipady=10)

    def load_csv_data(self):
        """
        Implements aggressive column name normalization to handle hidden characters.
        """
        file_path = filedialog.askopenfilename(
            title="Select Air Quality CSV File",
            filetypes=(("CSV files", "*.csv"), ("All files", "*.*"))
        )
        
        if not file_path:
            return

        try:
            # Load and skip blank lines
            self.data = pd.read_csv(file_path, skip_blank_lines=True)
            
            # --- Aggressive column name normalization ---
            
            # 1. Normalize column names (remove spaces/non-alphanumeric, convert to uppercase)
            original_cols = self.data.columns.tolist()
            normalized_cols = (
                self.data.columns.astype(str)
                .str.strip()
                .str.replace(r'[^\w\.]', '', regex=True) # Remove all non-alphanumeric except dot
                .str.upper()
            )
            self.data.columns = normalized_cols 
            
            # 2. Drop rows where all cells are NaN
            self.data.dropna(how='all', inplace=True)
            
            # 3. Search for the column containing 'PM2.5' in the normalized names
            pm_cols = [col for col in self.data.columns if 'PM2.5' in col]
            
            if not pm_cols:
                 raise ValueError(f"Could not find a PM2.5 column. Checked original headers: {original_cols}. Normalized headers: {self.data.columns.tolist()}")

            # Assume the first match is the correct column
            self.pm_col_name = pm_cols[0]
            
            # 4. Ensure the identified column is numeric
            self.data[self.pm_col_name] = pd.to_numeric(self.data[self.pm_col_name], errors='coerce')
            
            # Use index as the time-series axis for plotting
            self.data['Time_Point'] = self.data.index 

            # Process the data using the identified column name
            self.data = calculate_aqi_and_risk(self.data, self.pm_col_name) 
            
            # Update UI
            self.path_label.config(text=f"âœ… File loaded and processed successfully (PM Col: '{self.pm_col_name}').\nFile: {os.path.basename(file_path)}")
            messagebox.showinfo("Success", "Data loaded, AQI and Risk calculated. Switching to Dashboard.")
            
            self.notebook.select(self.dashboard_tab)
            self.create_dashboard_ui()
            
        except ValueError as ve:
            messagebox.showerror("Data Error", str(ve))
            self.data = None
        except Exception as e:
            messagebox.showerror("File Error", f"Could not load or process file: {e}")
            self.data = None
            
    def create_dashboard_ui(self, initial=False):
        """Clears and redraws the dashboard with statistics and plots."""
        for widget in self.dashboard_tab.winfo_children():
            widget.destroy()

        if initial or self.data is None:
            ttk.Label(self.dashboard_tab, text="â†©ï¸ Please upload a valid CSV file in the 'Data Uploader' tab to view the dashboard.", font=("Helvetica", 14, 'italic')).pack(pady=50)
            return

        ttk.Label(self.dashboard_tab, text="Air Quality & Health Risk Summary", style='Header.TLabel').pack(pady=(0, 15))
        
        # --- Statistics Frame ---
        stats_frame = ttk.Frame(self.dashboard_tab, padding="10")
        stats_frame.pack(fill='x', pady=5)

        # Safely calculate statistics, defaulting to 'N/A' if all values are NaN
        valid_aqi = self.data['AQI'].dropna()
        valid_risk = self.data['Risk_Category'].dropna()

        # Safely compute statistics - USING BUILT-IN round() FUNCTION
        if not valid_aqi.empty:
            max_aqi = int(round(valid_aqi.max(), 0))  # Use built-in round() function
            avg_aqi = round(valid_aqi.mean(), 1)      # Use built-in round() function
        else:
            max_aqi = "N/A"
            avg_aqi = "N/A"
        
        # Check if mode() returns any value before accessing iloc[0]
        mode_series = valid_risk.mode()
        max_risk = mode_series.iloc[0] if not mode_series.empty else "No Valid Data"
        
        # Display statistics
        ttk.Label(stats_frame, text=f"Max AQI: {max_aqi}", font=("Helvetica", 12, 'bold'), foreground='#cc0000').grid(row=0, column=0, padx=30, pady=5)
        ttk.Label(stats_frame, text=f"Avg AQI: {avg_aqi}", font=("Helvetica", 12)).grid(row=0, column=1, padx=30, pady=5)
        ttk.Label(stats_frame, text=f"Most Frequent Risk: {max_risk}", font=("Helvetica", 12)).grid(row=0, column=2, padx=30, pady=5)
        
        # --- Plotting Area Frame ---
        plot_frame = ttk.Frame(self.dashboard_tab)
        plot_frame.pack(pady=10, fill='both', expand=True)

        # 1. AQI Time Series Plot (only plot if there's valid AQI data)
        if not valid_aqi.empty:
            fig1, ax1 = plt.subplots(figsize=(8, 3.5))
            plot_data = self.data.dropna(subset=['AQI'])
            ax1.plot(plot_data['Time_Point'], plot_data['AQI'], label='Daily AQI', color='#1f77b4', linewidth=2)
            ax1.set_title('Air Quality Index Over Time (by Row Index)', fontsize=12)
            ax1.set_xlabel('Time Point (Row Index)', fontsize=10)
            ax1.set_ylabel('AQI Value', fontsize=10)
            ax1.tick_params(axis='x', rotation=0, labelsize=8)
            ax1.grid(axis='y', linestyle='--', alpha=0.7)
            ax1.legend()
            fig1.tight_layout()

            canvas1 = FigureCanvasTkAgg(fig1, master=plot_frame)
            canvas_widget1 = canvas1.get_tk_widget()
            canvas_widget1.pack(side=tk.TOP, fill='both', expand=True, padx=5, pady=5)
            canvas1.draw()
        else:
            ttk.Label(plot_frame, text="No valid AQI data to plot the time series.", foreground='red').pack(pady=20)

        # 2. Risk Category Distribution (Bar Plot)
        if not valid_risk.empty:
            fig2, ax2 = plt.subplots(figsize=(8, 2.5))
            risk_counts = valid_risk.value_counts()
            
            risk_colors = {
                'GOOD': 'green', 
                'MODERATE': 'gold', 
                'UNHEALTHY FOR SENSITIVE GROUPS': 'orange', 
                'UNHEALTHY': 'red', 
                'VERY UNHEALTHY': 'purple', 
                'HAZARDOUS': 'maroon'
            }
                           
            categories_ordered = ['Good', 'Moderate', 'Unhealthy for Sensitive Groups', 'Unhealthy', 'Very Unhealthy', 'Hazardous']
            # Map counts back to original case for plotting
            counts_sorted = risk_counts.reindex(categories_ordered).dropna()
            colors_applied = [risk_colors.get(c.upper(), 'gray') for c in counts_sorted.index]
            
            bars = ax2.bar(counts_sorted.index, counts_sorted.values, color=colors_applied)
            ax2.set_title('Health Risk Category Distribution', fontsize=12)
            ax2.set_ylabel('Count of Days', fontsize=10)
            ax2.tick_params(axis='x', rotation=15, labelsize=8)
            
            # Add value labels on bars
            for bar in bars:
                height = bar.get_height()
                ax2.text(bar.get_x() + bar.get_width()/2., height,
                        f'{int(height)}', ha='center', va='bottom', fontsize=8)
                
            fig2.tight_layout()
            
            canvas2 = FigureCanvasTkAgg(fig2, master=plot_frame)
            canvas_widget2 = canvas2.get_tk_widget()
            canvas_widget2.pack(side=tk.BOTTOM, fill='both', expand=True, padx=5, pady=5)
            canvas2.draw()
        else:
            ttk.Label(plot_frame, text="No valid Risk Category data to plot the distribution.", foreground='red').pack(pady=20)


# --- 3. Execution ---
if __name__ == '__main__':
    # DPI Awareness fix for Windows
    if sys.platform.startswith('win'):
        try:
            from ctypes import windll
            windll.shcore.SetProcessDpiAwareness(1)
        except:
            pass
            
    app = AirQualityDashboard()
    app.mainloop()
